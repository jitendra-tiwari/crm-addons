<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <link href='CSS/Eventfullcalendar.css' rel='stylesheet' />
    <link href='CSS/Eventfullcalendar.print.css' rel='stylesheet' media='print' />
    <script src='Script/Eventmoment.min.js'></script>
    <script src='Script/Eventjquery.min.js'></script>
    <!--<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>-->

    <script src='Script/Eventfullcalendar.min.js'></script>
    <script>
        var appoinmentObject = new Array();
        var taskObject = new Array();
        var phoneCallObject = new Array();

        $(document).ready(function () {
            $("#chk_appoint").change(function () {
                if ($("#chk_appoint").prop("checked")) {
                    getAppointment();
                }
                else {
                    removeEvents(appoinmentObject);
                    appoinmentObject = [];

                }
            });
            $("#chk_task").change(function () {
                if ($("#chk_task").prop("checked")) {
                    getTasks();
                }
                else {
                    removeEvents(taskObject);
                    taskObject = [];

                }
            });

            $("#chk_phonecall").change(function () {
                if ($("#chk_phonecall").prop("checked")) {
                    getPhoneCall();
                }
                else {
                    removeEvents(phoneCallObject);
                    phoneCallObject = [];

                }
            });

            //clear all
            $("#chk_clearall").change(function () {
                if ($("#chk_clearall").prop("checked")) {
                    $('#calendar').fullCalendar('removeEventSources');
                }
                else {

                    //appointment
                    if ($("#chk_appoint").prop("checked")) {
                        getAppointment();
                    }
                    else {
                        removeEvents(appoinmentObject);
                        appoinmentObject = [];

                    }



                    //task
                    if ($("#chk_task").prop("checked")) {
                        getTasks();
                    }
                    else {
                        removeEvents(taskObject);
                        taskObject = [];

                    }
                    //phonecall

                    if ($("#chk_phonecall").prop("checked")) {
                        getPhoneCall();
                    }
                    else {
                        removeEvents(phoneCallObject);
                        phoneCallObject = [];

                    }


                }

            });
          
           
               
                //initCalendar(appoinmentObject);
                //ShowSelectedCheckBox();
            SelectConfigurationDetails();
           
        });

        function initCalendar(eventData) {

            $('#calendar').fullCalendar({
                header: { center: 'month,basicWeek,basicDay' },
                //defaultDate: '2016-09-12',
                editable: true,
                eventLimit: true, // allow "more" link when too many events
                events: eventData,
                eventClick: function (event) {
                    if (event.id && event.url) {
                        var entityName = event.url;
                        var id = event.id;
                        openWindowPopup(entityName, id);
                        return false;
                    }
                }


            });
        }

        function refreshCalendar(sources) {
            // $('#calendar').fullCalendar('refetchEvents');
            $('#calendar').fullCalendar('addEventSource', sources);
            //$('#calendar').fullCalendar('refetchEventSources', sources);
        }

        function removeEvents(source) {
            $('#calendar').fullCalendar('removeEventSource', source)
        }
        function openWindowPopup(entity, id) {
            var windowOptions = {
                openInNewWindow: true
            };
            parent.Xrm.Utility.openEntityForm(entity, id, null, windowOptions);
           // parent.Xrm.Utility.openEntityForm(entity, id);
        }

        function ShowSelectedCheckBox()
        {
        var Appointment=    $("#chk_appoint").prop("checked", true);
        var Task = $("#chk_task").prop("checked", true);
        var PhoneCall = $("#chk_phonecall").prop("checked", true);
        if (Appointment && Task && PhoneCall) {
            getAppointment();
            getTasks();
            getPhoneCall();
        }
        }
        function getAppointment() {
            var serverUrl = parent.Xrm.Page.context.getClientUrl();
            $.getJSON(serverUrl + "/XRMServices/2011/OrganizationData.svc/AppointmentSet", {}, function (data) {

                appoinmentObject = [];
                // taskObject = [];

                $.each(data.d.results, function (i, field) {
                    var scheduledStart = oDataDateToDate(field.ScheduledStart);
                    var scheduledEnd = oDataDateToDate(field.ScheduledEnd);
                    if (scheduledStart != null && scheduledEnd != null) {
                        var o = { id: field.ActivityId, title: field.Subject, start: scheduledStart, end: scheduledEnd, url: "appointment" };
                        appoinmentObject.push(o);
                    }

                    else if (scheduledStart != null && scheduledEnd == null) {
                        var o = { id: field.ActivityId, title: field.Subject, start: scheduledStart, url: "appointment" };
                        appoinmentObject.push(o);
                    }
                });
                refreshCalendar(appoinmentObject);
            });

        }

        function getTasks() {
            var serverUrl = parent.Xrm.Page.context.getClientUrl();
            $.getJSON(serverUrl + "/XRMServices/2011/OrganizationData.svc/TaskSet", {}, function (data) {
                taskObject = [];
                // appoinmentObject = [];

                $.each(data.d.results, function (i, field) {

                    var actualStart = oDataDateToDate(field.ActualStart);
                    var actualEnd = oDataDateToDate(field.ActualEnd);
                    if (actualStart != null && actualEnd != null) {

                        var o = { id: field.ActivityId, title: field.Subject, start: actualStart, end: actualEnd, url: "task" };
                        taskObject.push(o);
                    }
                    else if (actualStart != null && actualEnd == null) {

                        var o = { id: field.ActivityId, title: field.Subject, start: actualStart, url: "task" };
                        taskObject.push(o);
                    }
                });
                refreshCalendar(taskObject);
            });
        }

        function getPhoneCall() {
            var serverUrl = parent.Xrm.Page.context.getClientUrl();
            $.getJSON(serverUrl + "/XRMServices/2011/OrganizationData.svc/PhoneCallSet", {}, function (data) {
                phoneCallObject = [];
                // appoinmentObject = [];

                $.each(data.d.results, function (i, field) {

                    var actualStart = oDataDateToDate(field.ActualStart);
                    var actualEnd = oDataDateToDate(field.ActualEnd);
                    if (actualStart != null && actualEnd != null) {
                        var o = { id: field.ActivityId, title: field.Subject, start: actualStart, end: actualEnd, url: "phonecall" };
                        phoneCallObject.push(o);

                    }
                    else if (actualStart != null && actualEnd == null) {

                        var o = { id: field.ActivityId, title: field.Subject, start: actualStart, url: "phonecall" };
                        phoneCallObject.push(o);
                    }

                });

                refreshCalendar(phoneCallObject);

            });
        }
        function oDataDateToDate(odataDate) {
            if (odataDate == null || odataDate == "") { return null; };
            var dt = odataDate.replace("/Date(", "").replace(")/", "");
            var dateValue = new Date(parseInt(dt, 10));

            var yyyy = dateValue.getFullYear().toString();
            var dd = (dateValue.getDate()).toString();
            var mm = (dateValue.getMonth() + 1).toString(); // month in JS start from 0

            var mmChars = mm.split('');
            var ddChars = dd.split('');

            //var hours = dateValue.getHours() > 12 ? dateValue.getHours() - 12 : dateValue.getHours();
            var hours = dateValue.getHours();
            var am_pm = dateValue.getHours() >= 12 ? "PM" : "AM";
            hours = hours < 10 ? "0" + hours : hours;
            var minutes = dateValue.getMinutes() < 10 ? "0" + dateValue.getMinutes() : dateValue.getMinutes();
            var seconds = dateValue.getSeconds() < 10 ? "0" + dateValue.getSeconds() : dateValue.getSeconds();

            //var completeDate = yyyy + '-' + (mmChars[1] ? mm : "0" + mmChars[0]) + '-' + (ddChars[1] ? dd : "0" + ddChars[0]);
            var completeDate = yyyy + '-' + (mmChars[1] ? mm : "0" + mmChars[0]) + '-' + (ddChars[1] ? dd : "0" + ddChars[0]) + " " + hours + ":" + minutes + ":" + seconds;

            return completeDate;
        }
        function SelectConfigurationDetails() {           
           
            var serverUrl = parent.Xrm.Page.context.getClientUrl();

            var oDataUri = serverUrl + "/XRMServices/2011/OrganizationData.svc/dots_eventconfigurationSet";

            $.ajax({
                type: "GET",
                contentType: "application/json; charset=utf-8",
                datatype: "json",
                url: oDataUri,
                beforeSend: function (XMLHttpRequest) { XMLHttpRequest.setRequestHeader("Accept", "application/json"); },
                success: function (data, textStatus, XmlHttpRequest) {
                    
                    var output = data.d.results;                    
                    if (output.length == 0) {
                        alert("Please register to view events calendar!");
                    }
                    else {
                        //if user has register  
                        $("#side-panel").show();
                        initCalendar(appoinmentObject);
                        ShowSelectedCheckBox();

                    }
                   
                   
                },
                error: function (XmlHttpRequest, textStatus, errorThrown) {                   
                    alert("error ha occurs");

                }
            });

           

        }
       

    </script>
    <style>
        body {
            margin: 40px 10px;
            padding: 0;
            font-family: "Lucida Grande",Helvetica,Arial,Verdana,sans-serif;
            font-size: 14px;
        }

        #calendar {            
            margin: 0px 150px;
            position:inherit;
        }

        #side-panel {            
            max-width:150px;
            position:absolute;
            left:10px;
            top:26px;
        }
        #side-panel div {            
            padding-bottom:10px;
        }
    </style>
</head>
<body>   
    <div id="side-panel" style="display:none;">
        <h2>Activities</h2>
        <hr />
        <div>
            <label class="radio-inline" for="chk_appoint">
                <input type="checkbox" id="chk_appoint">
                Appointments
            </label>
        </div>
        <div>
            <label class="radio-inline" for="chk_task">
                <input type="checkbox" id="chk_task">
                Tasks
            </label>
        </div>
        <div>
            <label class="radio-inline" for="chk_phonecall">
                <input type="checkbox" id="chk_phonecall">
                Phone/Calls
            </label>
        </div>
    </div>
    <div id='calendar'></div>
</body>
</html>
